<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบเช็คอิน/เอาท์พนักงาน - ปรับปรุงแล้ว</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connection-status.online {
            background: var(--success-color);
            color: white;
        }

        .connection-status.offline {
            background: var(--danger-color);
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .system-status {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            color: white;
            text-align: center;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            color: white;
            border-radius: 10px;
            transition: all 0.3s ease;
            user-select: none;
        }

        .nav-tab.active {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(15px);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255,255,255,0.1);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Enhanced Loading States */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced Cards */
        .admin-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .admin-card {
            background: var(--light-color);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .admin-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .admin-card h3 {
            color: var(--dark-color);
            margin-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Enhanced Alerts */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid var(--success-color);
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid var(--danger-color);
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid var(--warning-color);
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid var(--info-color);
        }

        /* Enhanced Buttons */
        .btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            min-width: 120px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #1e7e34);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #c82333);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #e0a800);
            color: #212529;
        }

        /* Enhanced Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Enhanced Stats */
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-value {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1em;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            max-width: 350px;
        }

        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 10px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-header {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toast-body {
            padding: 12px 16px;
        }

        /* Progress Bar */
        .progress {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            transition: width 0.3s ease;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                flex-direction: column;
                gap: 5px;
            }
            
            .nav-tab {
                flex: none;
                min-height: 50px;
            }
            
            .admin-section {
                grid-template-columns: 1fr;
            }
            
            .tab-content {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .admin-card {
                background: #2d3748;
                color: white;
                border-color: #4a5568;
            }
            
            .form-control {
                background: #2d3748;
                border-color: #4a5568;
                color: white;
            }
        }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="connection-status online">
        🟢 เชื่อมต่อแล้ว
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <div class="container">
        <div class="header">
            <h1>🏢 ระบบเช็คอิน/เอาท์พนักงาน</h1>
            <p>ระบบจัดการเวลาทำงานอัจฉริยะ - เวอร์ชันปรับปรุง</p>
        </div>

        <!-- System Status -->
        <div class="system-status" id="systemStatus">
            <div class="progress">
                <div class="progress-bar" style="width: 100%"></div>
            </div>
            ✅ <strong>ระบบพร้อมใช้งาน!</strong> 
            เชื่อมต่อ Google Apps Script เรียบร้อยแล้ว
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('checkin')">📱 เช็คอิน/เอาท์</div>
            <div class="nav-tab" onclick="showTab('dashboard')">📊 แดชบอร์ด</div>
            <div class="nav-tab" onclick="showTab('analytics')">📈 วิเคราะห์</div>
            <div class="nav-tab" onclick="showTab('reports')">📋 รายงาน</div>
            <div class="nav-tab" onclick="showTab('settings')">⚙️ ตั้งค่า</div>
        </div>

        <!-- Check-in/out Tab -->
        <div id="checkin" class="tab-content active">
            <h2>🎯 เช็คอิน/เอาท์พนักงาน</h2>
            
            <div class="admin-section">
                <div class="admin-card">
                    <h3>👥 เลือกพนักงาน</h3>
                    <div class="form-group">
                        <select id="employeeSelect" class="form-control">
                            <option value="">กำลังโหลดข้อมูลพนักงาน...</option>
                        </select>
                    </div>
                    
                    <div id="employeeInfo" style="display: none;">
                        <div class="stat-item">
                            <span>ชื่อ:</span>
                            <span class="stat-value" id="empName"></span>
                        </div>
                        <div class="stat-item">
                            <span>ตำแหน่ง:</span>
                            <span class="stat-value" id="empPosition"></span>
                        </div>
                        <div class="stat-item">
                            <span>สถานะ:</span>
                            <span class="stat-value" id="empStatus"></span>
                        </div>
                    </div>
                </div>

                <div class="admin-card">
                    <h3>📍 ข้อมูลตำแหน่ง</h3>
                    <div id="locationInfo">
                        <div class="loading-container">
                            <div class="spinner"></div>
                            <p>กำลังตรวจสอบตำแหน่ง...</p>
                        </div>
                    </div>
                </div>

                <div class="admin-card">
                    <h3>🕐 ข้อมูลเวลา</h3>
                    <div class="stat-item">
                        <span>เวลาปัจจุบัน:</span>
                        <span class="stat-value" id="currentTime"></span>
                    </div>
                    <div class="stat-item">
                        <span>เวลาเข้างาน:</span>
                        <span class="stat-value" id="workStartTime">08:30</span>
                    </div>
                    <div class="stat-item">
                        <span>เวลาเลิกงาน:</span>
                        <span class="stat-value" id="workEndTime">17:30</span>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin: 30px 0;">
                <button class="btn btn-success" onclick="checkIn()" id="checkinBtn" disabled>
                    🟢 เช็คอิน
                </button>
                <button class="btn btn-danger" onclick="checkOut()" id="checkoutBtn" disabled>
                    🔴 เช็คเอาท์
                </button>
            </div>

            <div id="messageArea"></div>
        </div>

        <!-- Enhanced Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <h2>📊 Dashboard แบบ Real-time</h2>
            
            <div class="admin-section">
                <div class="admin-card">
                    <h3>📈 สถิติวันนี้</h3>
                    <div id="todayStats">
                        <div class="loading-container">
                            <div class="spinner"></div>
                            <p>กำลังโหลดข้อมูล...</p>
                        </div>
                    </div>
                </div>

                <div class="admin-card">
                    <h3>⏰ การมาสาย</h3>
                    <div id="lateEmployees">
                        <div class="loading-container">
                            <div class="spinner"></div>
                            <p>กำลังวิเคราะห์...</p>
                        </div>
                    </div>
                </div>

                <div class="admin-card">
                    <h3>🏃‍♂️ การกลับก่อนเวลา</h3>
                    <div id="earlyEmployees">
                        <div class="loading-container">
                            <div class="spinner"></div>
                            <p>กำลังวิเคราะห์...</p>
                        </div>
                    </div>
                </div>

                <div class="admin-card">
                    <h3>📊 ประสิทธิภาพทีม</h3>
                    <div id="teamPerformance">
                        <div class="stat-item">
                            <span>คะแนนเฉลี่ย:</span>
                            <span class="stat-value">87%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" style="width: 87%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="refreshDashboard()">🔄 รีเฟรชข้อมูล</button>
                <button class="btn btn-success" onclick="exportDashboard()">📊 ส่งออกรายงาน</button>
            </div>
        </div>

        <!-- New Analytics Tab -->
        <div id="analytics" class="tab-content">
            <h2>📈 การวิเคราะห์ข้อมูลขั้นสูง</h2>
            
            <div class="admin-section">
                <div class="admin-card">
                    <h3>📊 แนวโน้มรายสัปดาห์</h3>
                    <canvas id="weeklyChart" width="400" height="200"></canvas>
                </div>

                <div class="admin-card">
                    <h3>🎯 ข้อเสนอแนะ AI</h3>
                    <div id="aiInsights">
                        <div class="alert alert-info">
                            💡 <strong>ข้อเสนอแนะ:</strong> พนักงานมีแนวโน้มมาสายในวันจันทร์ ควรพิจารณาปรับเวลาเข้างานในวันจันทร์
                        </div>
                        <div class="alert alert-success">
                            ✅ <strong>จุดแข็ง:</strong> ทีมมีความสม่ำเสมอในการเช็คเอาท์ 95%
                        </div>
                    </div>
                </div>

                <div class="admin-card">
                    <h3>🏆 พนักงานดีเด่น</h3>
                    <div id="topEmployees">
                        <div class="stat-item">
                            <span>🥇 สมชาย ใจดี</span>
                            <span class="stat-value">98%</span>
                        </div>
                        <div class="stat-item">
                            <span>🥈 สมหญิง ขยัน</span>
                            <span class="stat-value">95%</span>
                        </div>
                        <div class="stat-item">
                            <span>🥉 วิทยา ศรีวิชา</span>
                            <span class="stat-value">92%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Reports Tab -->
        <div id="reports" class="tab-content">
            <h2>📋 รายงานแบบอัตโนมัติ</h2>
            
            <div class="admin-section">
                <div class="admin-card">
                    <h3>📅 รายงานตามช่วงเวลา</h3>
                    <div class="form-group">
                        <label>ประเภทรายงาน:</label>
                        <select class="form-control" id="reportType">
                            <option value="daily">รายวัน</option>
                            <option value="weekly">รายสัปดาห์</option>
                            <option value="monthly">รายเดือน</option>
                            <option value="custom">กำหนดเอง</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ช่วงเวลา:</label>
                        <input type="date" class="form-control" id="startDate">
                        <input type="date" class="form-control" id="endDate" style="margin-top: 10px;">
                    </div>
                    <button class="btn" onclick="generateAdvancedReport()">🔍 สร้างรายงาน</button>
                </div>

                <div class="admin-card">
                    <h3>👤 รายงานรายบุคคล</h3>
                    <div class="form-group">
                        <label>เลือกพนักงาน:</label>
                        <select class="form-control" id="reportEmployee">
                            <option value="">เลือกพนักงาน</option>
                        </select>
                    </div>
                    <button class="btn" onclick="generatePersonalReport()">👤 ดูรายงานส่วนบุคคล</button>
                </div>

                <div class="admin-card">
                    <h3>📊 รายงานสำเร็จรูป</h3>
                    <button class="btn btn-success" onclick="quickReport('attendance')">📋 รายงานการมาทำงาน</button>
                    <button class="btn btn-warning" onclick="quickReport('overtime')">⏰ รายงาน OT</button>
                    <button class="btn btn-info" onclick="quickReport('salary')">💰 รายงานเงินเดือน</button>
                </div>
            </div>

            <div id="reportResult" style="margin-top: 30px;"></div>
        </div>

        <!-- Enhanced Settings Tab -->
        <div id="settings" class="tab-content">
            <h2>⚙️ การตั้งค่าระบบขั้นสูง</h2>
            
            <div class="admin-section">
                <div class="admin-card">
                    <h3>🔗 การเชื่อมต่อ</h3>
                    <div class="form-group">
                        <label>Google Apps Script URL:</label>
                        <input type="url" class="form-control" id="googleScriptUrl" placeholder="https://script.google.com/macros/s/[ID]/exec">
                    </div>
                    <div class="form-group">
                        <label>Google Sheets URL:</label>
                        <input type="url" class="form-control" id="googleSheetsUrl" placeholder="https://docs.google.com/spreadsheets/d/[ID]/edit">
                    </div>
                    <button class="btn btn-success" onclick="testConnection()">🧪 ทดสอบการเชื่อมต่อ</button>
                    <div id="connectionTest"></div>
                </div>

                <div class="admin-card">
                    <h3>🏢 ข้อมูลบริษัท</h3>
                    <div class="form-group">
                        <label>ชื่อบริษัท:</label>
                        <input type="text" class="form-control" id="companyName" value="บริษัท ABC จำกัด">
                    </div>
                    <div class="form-group">
                        <label>เวลาเข้า-เลิกงาน:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="time" class="form-control" id="workStart" value="08:30">
                            <input type="time" class="form-control" id="workEnd" value="17:30">
                        </div>
                    </div>
                </div>

                <div class="admin-card">
                    <h3>📍 ตั้งค่า GPS</h3>
                    <div class="form-group">
                        <label>พิกัดออฟฟิศ:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" class="form-control" id="officeLat" placeholder="Latitude" step="0.000001">
                            <input type="number" class="form-control" id="officeLng" placeholder="Longitude" step="0.000001">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>รัศมีที่อนุญาต (เมตร):</label>
                        <input type="number" class="form-control" id="allowedRadius" value="100">
                    </div>
                    <button class="btn" onclick="getCurrentLocation()">📍 ใช้ตำแหน่งปัจจุบัน</button>
                </div>

                <div class="admin-card">
                    <h3>🔔 การแจ้งเตือน</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableNotifications"> 
                            เปิดการแจ้งเตือน
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableAutoBackup"> 
                            สำรองข้อมูลอัตโนมัติ
                        </label>
                    </div>
                    <button class="btn" onclick="requestNotificationPermission()">🔔 ขออนุญาตแจ้งเตือน</button>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-success" onclick="saveAllSettings()">💾 บันทึกการตั้งค่าทั้งหมด</button>
                <button class="btn btn-warning" onclick="resetSettings()">🔄 รีเซ็ตเป็นค่าเริ่มต้น</button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Global Variables
        let systemConfig = {
            googleScriptUrl: '',
            googleSheetsUrl: '',
            companyName: 'บริษัท ABC จำกัด',
            workStartTime: '08:30',
            workEndTime: '17:30',
            breakTime: 60,
            otRate: 100,
            socialSecurityRate: 5,
            socialSecurityCap: 750,
            officeLat: 16.386829,
            officeLng: 102.831119,
            allowedRadius: 100,
            enableNotifications: false,
            enableAutoBackup: false
        };

        let employees = [];
        let currentEmployee = null;
        let userLocation = null;
        let requestCounter = 0;
        let connectionStatus = true;

        // Enhanced Classes
        class RequestManager {
            constructor() {
                this.cache = new Map();
                this.pendingRequests = new Map();
            }

            async request(action, data = {}, useCache = false, maxRetries = 3) {
                const cacheKey = `${action}_${JSON.stringify(data)}`;
                
                // Check cache first
                if (useCache && this.cache.has(cacheKey)) {
                    const cached = this.cache.get(cacheKey);
