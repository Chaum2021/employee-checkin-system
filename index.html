<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô/‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .config-alert {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            color: white;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(15px);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .tab-content.active {
            display: block;
        }

        .checkin-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .employee-select {
            width: 100%;
            max-width: 300px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 16px;
        }

        .status-card {
            background: linear-gradient(135deg, #a8e6cf 0%, #88d8a3 100%);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .checkin-btn, .checkout-btn {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .checkin-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .checkout-btn {
            background: linear-gradient(135deg, #f44336, #da190b);
            color: white;
        }

        .checkin-btn:hover, .checkout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .checkin-btn:disabled, .checkout-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .location-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .admin-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .admin-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .admin-card h3 {
            color: #495057;
            margin-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-value {
            font-weight: bold;
            color: #495057;
        }

        .late-item {
            background: #fff3cd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
        }

        .early-item {
            background: #f8d7da;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #dc3545;
        }

        .settings-form {
            display: grid;
            gap: 20px;
        }

        .form-group {
            display: grid;
            gap: 8px;
        }

        .form-group label {
            font-weight: bold;
            color: #495057;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .admin-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô/‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h1>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</p>
        </div>

        <!-- Configuration Alert -->
        <div class="config-alert" id="configAlert">
            ‚ö†Ô∏è <strong>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</strong> 
            ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('checkin')">üì± ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô/‡πÄ‡∏≠‡∏≤‡∏ó‡πå</div>
            <div class="nav-tab" onclick="showTab('admin')">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</div>
            <div class="nav-tab" onclick="showTab('reports')">üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
            <div class="nav-tab" onclick="showTab('settings')">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
        </div>

        <!-- Check-in/out Tab -->
        <div id="checkin" class="tab-content active">
            <div class="checkin-section">
                <h2>‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô/‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h2>
                
                <select id="employeeSelect" class="employee-select">
                    <option value="">‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...</option>
                </select>

                <div id="statusCard" class="status-card" style="display: none;">
                    <h3 id="employeeName"></h3>
                    <p id="currentStatus">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</p>
                    <p id="currentTime"></p>
                </div>

                <div class="location-info" id="locationInfo" style="display: none;">
                    <h4>üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h4>
                    <p id="locationText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...</p>
                    <p id="locationStatus"></p>
                </div>

                <div>
                    <button class="checkin-btn" onclick="checkIn()" id="checkinBtn" disabled>
                        üü¢ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô
                    </button>
                    <button class="checkout-btn" onclick="checkOut()" id="checkoutBtn" disabled>
                        üî¥ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå
                    </button>
                </div>
            </div>

            <div id="messageArea"></div>
        </div>

        <!-- Admin Dashboard Tab -->
        <div id="admin" class="tab-content">
            <h2>üìä Dashboard ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h2>
            
            <div class="admin-section">
                <div class="admin-card">
                    <h3>üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                    <div id="todayStats">
                        <div class="loading"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
                    </div>
                </div>

                <div class="admin-card">
                    <h3>‚è∞ ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                    <div id="lateEmployees">
                        <div class="loading"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
                    </div>
                </div>

                <div class="admin-card">
                    <h3>üèÉ‚Äç‚ôÇÔ∏è ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                    <div id="earlyEmployees">
                        <div class="loading"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
                    </div>
                </div>

                <div class="admin-card">
                    <h3>üí∞ ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>
                    <div id="salaryStats">
                        <div class="loading"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="refreshDashboard()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <h2>üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h2>
            
            <div class="admin-section">
                <div class="admin-card">
                    <h3>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
                    <div class="form-group">
                        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
                        <select id="reportMonth">
                            <option value="2025-07">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏° 2568</option>
                            <option value="2025-06">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô 2568</option>
                            <option value="2025-05">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏° 2568</option>
                        </select>
                    </div>
                    <button class="btn" onclick="generateReport()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                    <button class="btn" onclick="exportToSheets()" style="margin-left: 10px;">‡∏î‡∏π‡πÉ‡∏ô Google Sheets</button>
                </div>

                <div class="admin-card">
                    <h3>üíº ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h3>
                    <div class="form-group">
                        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
                        <select id="reportEmployee">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option>
                        </select>
                    </div>
                    <button class="btn" onclick="generateEmployeeReport()">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                </div>
            </div>

            <div id="reportResult" style="margin-top: 30px;"></div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <h2>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h2>
            
            <div class="admin-section">
                <div class="admin-card">
                    <h3>üîó ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets</h3>
                    <div class="settings-form">
                        <div class="form-group">
                            <label>Google Apps Script URL:</label>
                            <textarea id="googleScriptUrl" placeholder="‡∏ß‡∏≤‡∏áURL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà" rows="3"></textarea>
                            <small style="color: #666;">URL ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö: https://script.google.com/macros/s/[ID]/exec</small>
                        </div>
                        <div class="form-group">
                            <label>Google Sheets URL (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•):</label>
                            <input type="url" id="googleSheetsUrl" placeholder="https://docs.google.com/spreadsheets/d/[ID]/edit">
                        </div>
                        <button class="btn" onclick="testConnection()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
                    </div>
                </div>

                <div class="admin-card">
                    <h3>üè¢ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</h3>
                    <div class="settings-form">
                        <div class="form-group">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó:</label>
                            <input type="text" id="companyName" value="‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ABC ‡∏à‡∏≥‡∏Å‡∏±‡∏î">
                        </div>
                        <div class="form-group">
                            <label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô:</label>
                            <input type="time" id="workStartTime" value="08:30">
                        </div>
                        <div class="form-group">
                            <label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô:</label>
                            <input type="time" id="workEndTime" value="17:30">
                        </div>
                        <div class="form-group">
                            <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å‡πÄ‡∏ö‡∏£‡∏Ñ (‡∏ô‡∏≤‡∏ó‡∏µ):</label>
                            <input type="number" id="breakTime" value="60">
                        </div>
                    </div>
                </div>

                <div class="admin-card">
                    <h3>üí∞ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
                    <div class="settings-form">
                        <div class="form-group">
                            <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á OT (‡∏ö‡∏≤‡∏ó/‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á):</label>
                            <input type="number" id="otRate" value="100">
                        </div>
                        <div class="form-group">
                            <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° (%):</label>
                            <input type="number" id="socialSecurityRate" value="5" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° (‡∏ö‡∏≤‡∏ó):</label>
                            <input type="number" id="socialSecurityCap" value="750">
                        </div>
                    </div>
                </div>

                <div class="admin-card">
                    <h3>üìç ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®</h3>
                    <div class="settings-form">
                        <div class="form-group">
                            <label>Latitude:</label>
                            <input type="number" id="officeLat" value="16.386829" step="0.0001">
                        </div>
                        <div class="form-group">
                            <label>Longitude:</label>
                            <input type="number" id="officeLng" value="102.831119" step="0.0001">
                        </div>
                        <div class="form-group">
                            <label>‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï (‡πÄ‡∏°‡∏ï‡∏£):</label>
                            <input type="number" id="allowedRadius" value="1000">
                        </div>
                        <button class="btn" onclick="getCurrentLocation()">‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="saveSettings()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
            </div>
        </div>
    </div>

    <script>
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ in-memory storage ‡πÅ‡∏ó‡∏ô localStorage
        let config = {
            googleScriptUrl: '',
            googleSheetsUrl: '',
            companyName: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ABC ‡∏à‡∏≥‡∏Å‡∏±‡∏î',
            workStartTime: '08:30',
            workEndTime: '17:30',
            breakTime: 60,
            otRate: 100,
            socialSecurityRate: 5,
            socialSecurityCap: 750,
            officeLat: 16.386829,
            officeLng: 102.831119,
            allowedRadius: 1000
        };

        let employees = [];
        let currentEmployee = null;
        let userLocation = null;
        let requestCounter = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            checkLocationPermission();
            loadEmployees();
            checkConfiguration();
        });

        function checkConfiguration() {
            const configAlert = document.getElementById('configAlert');
            if (!config.googleScriptUrl) {
                configAlert.style.display = 'block';
            } else {
                configAlert.style.display = 'none';
            }
        }

        function loadSettings() {
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
            document.getElementById('googleScriptUrl').value = config.googleScriptUrl;
            document.getElementById('googleSheetsUrl').value = config.googleSheetsUrl;
            document.getElementById('companyName').value = config.companyName;
            document.getElementById('workStartTime').value = config.workStartTime;
            document.getElementById('workEndTime').value = config.workEndTime;
            document.getElementById('breakTime').value = config.breakTime;
            document.getElementById('otRate').value = config.otRate;
            document.getElementById('socialSecurityRate').value = config.socialSecurityRate;
            document.getElementById('socialSecurityCap').value = config.socialSecurityCap;
            document.getElementById('officeLat').value = config.officeLat;
            document.getElementById('officeLng').value = config.officeLng;
            document.getElementById('allowedRadius').value = config.allowedRadius;
        }

        function saveSettings() {
            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô memory ‡πÅ‡∏ó‡∏ô localStorage
            config.googleScriptUrl = document.getElementById('googleScriptUrl').value.trim();
            config.googleSheetsUrl = document.getElementById('googleSheetsUrl').value.trim();
            config.companyName = document.getElementById('companyName').value;
            config.workStartTime = document.getElementById('workStartTime').value;
            config.workEndTime = document.getElementById('workEndTime').value;
            config.breakTime = parseInt(document.getElementById('breakTime').value);
            config.otRate = parseFloat(document.getElementById('otRate').value);
            config.socialSecurityRate = parseFloat(document.getElementById('socialSecurityRate').value);
            config.socialSecurityCap = parseFloat(document.getElementById('socialSecurityCap').value);
            config.officeLat = parseFloat(document.getElementById('officeLat').value);
            config.officeLng = parseFloat(document.getElementById('officeLng').value);
            config.allowedRadius = parseInt(document.getElementById('allowedRadius').value);

            showMessage('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            checkConfiguration();
        }

        // JSONP function to bypass CORS
        function callGoogleScriptJSONP(action, data = {}) {
            return new Promise((resolve, reject) => {
                if (!config.googleScriptUrl) {
                    reject(new Error('Google Apps Script URL ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤'));
                    return;
                }

                requestCounter++;
                const callbackName = `jsonp_callback_${requestCounter}`;
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á parameters
                const params = new URLSearchParams();
                params.append('action', action);
                params.append('callback', callbackName);
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° data ‡∏•‡∏á‡πÉ‡∏ô parameters
                for (const key in data) {
                    if (typeof data[key] === 'object') {
                        params.append(key, JSON.stringify(data[key]));
                    } else {
                        params.append(key, data[key]);
                    }
                }

                const url = `${config.googleScriptUrl}?${params.toString()}`;
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á callback function
                window[callbackName] = function(response) {
                    // ‡∏•‡∏ö script element ‡πÅ‡∏•‡∏∞ callback function
                    document.head.removeChild(script);
                    delete window[callbackName];
                    
                    resolve(response);
                };

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á script element ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö JSONP
                const script = document.createElement('script');
                script.src = url;
                script.onerror = function() {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    reject(new Error('Failed to load script'));
                };

                document.head.appendChild(script);
            });
        }

        async function testConnection() {
            if (!config.googleScriptUrl) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Google Apps Script URL', 'warning');
                return;
            }

            try {
                showMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...', 'success');
                
                const result = await callGoogleScriptJSONP('getEmployees');
                
                if (result.success) {
                    showMessage('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ' + result.data.length + ' ‡∏Ñ‡∏ô', 'success');
                    loadEmployees(); // Reload employees
                } else {
                    showMessage('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + result.error, 'danger');
                }
            } catch (error) {
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'danger');
                console.error('Connection test error:', error);
            }
        }

        async function loadEmployees() {
            if (!config.googleScriptUrl) {
                // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• mock ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                employees = [
                    {id: 'EMP001', name: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', salary: 15000, position: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', status: '‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô'},
                    {id: 'EMP002', name: '‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏Ç‡∏¢‡∏±‡∏ô', salary: 18000, position: '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô', status: '‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô'},
                    {id: 'EMP003', name: '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏®‡∏£‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤', salary: 20000, position: '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£', status: '‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô'}
                ];
                updateEmployeeSelects();
                return;
            }

            try {
                const result = await callGoogleScriptJSONP('getEmployees');
                
                if (result.success) {
                    employees = result.data;
                    updateEmployeeSelects();
                } else {
                    // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• fallback
                    employees = [
                        {id: 'EMP001', name: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', salary: 15000, position: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', status: '‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô'}
                    ];
                    updateEmployeeSelects();
                }
            } catch (error) {
                console.error('Error loading employees:', error);
                // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• fallback
                employees = [
                    {id: 'EMP001', name: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', salary: 15000, position: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', status: '‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô'}
                ];
                updateEmployeeSelects();
            }
        }

        function updateEmployeeSelects() {
            const selects = ['employeeSelect', 'reportEmployee'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option>';
                    
                    employees.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.id;
                        option.textContent = `${emp.name} (${emp.id})`;
                        select.appendChild(option);
                    });
                }
            });
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(navTab => {
                navTab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked nav tab
            event.target.classList.add('active');

            // Load data for specific tabs
            if (tabName === 'admin') {
                loadDashboardData();
            }
        }

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('th-TH', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const currentTimeEl = document.getElementById('currentTime');
            if (currentTimeEl) {
                currentTimeEl.textContent = timeString;
            }
        }

        document.getElementById('employeeSelect').addEventListener('change', function() {
            const employeeId = this.value;
            if (employeeId) {
                currentEmployee = employees.find(emp => emp.id === employeeId);
                if (currentEmployee) {
                    showEmployeeStatus();
                    updateButtons();
                    updateLocationInfo();
                }
            } else {
                hideEmployeeStatus();
                currentEmployee = null;
                updateButtons();
            }
        });

        function showEmployeeStatus() {
            const statusCard = document.getElementById('statusCard');
            const employeeName = document.getElementById('employeeName');
            const currentStatus = document.getElementById('currentStatus');
            
            statusCard.style.display = 'block';
            employeeName.textContent = currentEmployee.name;
            currentStatus.textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô';
        }

        function hideEmployeeStatus() {
            document.getElementById('statusCard').style.display = 'none';
            document.getElementById('locationInfo').style.display = 'none';
        }

        function updateButtons() {
            const checkinBtn = document.getElementById('checkinBtn');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (currentEmployee && config.googleScriptUrl) {
                checkinBtn.disabled = false;
                checkoutBtn.disabled = false;
            } else {
                checkinBtn.disabled = true;
                checkoutBtn.disabled = true;
            }
        }

        async function checkLocationPermission() {
            if ('geolocation' in navigator) {
                try {
                    const position = await getCurrentPosition();
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    updateLocationInfo();
                } catch (error) {
                    showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', 'warning');
                }
            }
        }

        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                });
            });
        }

        function updateLocationInfo() {
            const locationInfo = document.getElementById('locationInfo');
            const locationText = document.getElementById('locationText');
            const locationStatus = document.getElementById('locationStatus');
            
            if (userLocation && currentEmployee) {
                locationInfo.style.display = 'block';
                locationText.textContent = `Lat: ${userLocation.lat.toFixed(6)}, Lng: ${userLocation.lng.toFixed(6)}`;
                
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    config.officeLat, config.officeLng
                );
                
                if (distance <= config.allowedRadius) {
                    locationStatus.innerHTML = '‚úÖ ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï';
                    locationStatus.style.color = '#28a745';
                } else {
                    locationStatus.innerHTML = `‚ùå ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏´‡πà‡∏≤‡∏á ${Math.round(distance)} ‡πÄ‡∏°‡∏ï‡∏£)`;
                    locationStatus.style.color = '#dc3545';
                }
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        async function checkIn() {
            if (!currentEmployee) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'warning');
                return;
            }

            if (!config.googleScriptUrl) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Google Apps Script URL ‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤', 'warning');
                return;
            }

            // Check location
            try {
                const position = await getCurrentPosition();
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    config.officeLat, config.officeLng
                );

                if (distance > config.allowedRadius) {
                    showMessage(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÑ‡∏î‡πâ ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏´‡πà‡∏≤‡∏á ${Math.round(distance)} ‡πÄ‡∏°‡∏ï‡∏£)`, 'danger');
                    return;
                }
            } catch (error) {
                showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS', 'danger');
                return;
            }

            // Perform check-in
            const now = new Date();
            const timeString = now.toLocaleTimeString('th-TH', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });

            // Check if late
            const checkInTime = now.getHours() * 60 + now.getMinutes();
            const startTime = parseInt(config.workStartTime.split(':')[0]) * 60 + 
                            parseInt(config.workStartTime.split(':')[1]);

            const lateMinutes = checkInTime > startTime ? checkInTime - startTime : 0;

            try {
                showMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô...', 'success');
                
                const result = await callGoogleScriptJSONP('checkin', {
                    employee: currentEmployee.name,
                    employeeId: currentEmployee.id,
                    date: now.toLocaleDateString('en-CA'), // YYYY-MM-DD format
                    time: timeString,
                    location: `${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}`,
                    status: lateMinutes > 0 ? '‡∏™‡∏≤‡∏¢' : '‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤',
                    lateMinutes: lateMinutes
                });

                if (result.success) {
                    if (lateMinutes > 0) {
                        showMessage(`‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡∏™‡∏≤‡∏¢ ${lateMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ)`, 'warning');
                    } else {
                        showMessage('‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    }
                    
                    // Update UI
                    document.getElementById('currentStatus').textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß (${timeString} ‡∏ô.)`;
                    document.getElementById('statusCard').style.background = 'linear-gradient(135deg, #a8e6cf 0%, #88d8a3 100%)';
                } else {
                    showMessage('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error, 'danger');
                }
            } catch (error) {
                showMessage('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ' + error.message, 'danger');
                console.error('CheckIn error:', error);
            }

            updateLocationInfo();
        }

        async function checkOut() {
            if (!currentEmployee) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'warning');
                return;
            }

            if (!config.googleScriptUrl) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Google Apps Script URL ‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤', 'warning');
                return;
            }

            // Check location
            try {
                const position = await getCurrentPosition();
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    config.officeLat, config.officeLng
                );

                if (distance > config.allowedRadius) {
                    showMessage(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡πÑ‡∏î‡πâ ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏´‡πà‡∏≤‡∏á ${Math.round(distance)} ‡πÄ‡∏°‡∏ï‡∏£)`, 'danger');
                    return;
                }
            } catch (error) {
                showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS', 'danger');
                return;
            }

            // Perform check-out
            const now = new Date();
            const timeString = now.toLocaleTimeString('th-TH', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });

            // Check if early leave
            const checkOutTime = now.getHours() * 60 + now.getMinutes();
            const endTime = parseInt(config.workEndTime.split(':')[0]) * 60 + 
                          parseInt(config.workEndTime.split(':')[1]);

            const earlyMinutes = checkOutTime < endTime ? endTime - checkOutTime : 0;

            try {
                showMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå...', 'success');
                
                const result = await callGoogleScriptJSONP('checkout', {
                    employee: currentEmployee.name,
                    employeeId: currentEmployee.id,
                    date: now.toLocaleDateString('en-CA'), // YYYY-MM-DD format
                    time: timeString,
                    location: `${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}`,
                    workHours: '8.0',
                    otHours: '0.0',
                    status: earlyMinutes > 0 ? '‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤' : '‡∏õ‡∏Å‡∏ï‡∏¥',
                    earlyMinutes: earlyMinutes
                });

                if (result.success) {
                    if (earlyMinutes > 0) {
                        showMessage(`‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ${earlyMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ)`, 'warning');
                    } else {
                        showMessage('‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    }
                    
                    // Update UI
                    document.getElementById('currentStatus').textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡πÅ‡∏•‡πâ‡∏ß (${timeString} ‡∏ô.)`;
                    document.getElementById('statusCard').style.background = 'linear-gradient(135deg, #ffd3a5 0%, #fd9853 100%)';
                } else {
                    showMessage('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error, 'danger');
                }
            } catch (error) {
                showMessage('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ' + error.message, 'danger');
                console.error('CheckOut error:', error);
            }
        }

        async function loadDashboardData() {
            if (!config.googleScriptUrl) {
                document.getElementById('todayStats').innerHTML = '<p style="color: #dc3545;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Google Apps Script URL</p>';
                document.getElementById('lateEmployees').innerHTML = '<p style="color: #dc3545;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Google Apps Script URL</p>';
                document.getElementById('earlyEmployees').innerHTML = '<p style="color: #dc3545;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Google Apps Script URL</p>';
                updateSalaryStats();
                return;
            }

            try {
                const result = await callGoogleScriptJSONP('getDashboardData');
                
                if (result.success) {
                    const data = result.data;
                    
                    // Update today's stats
                    document.getElementById('todayStats').innerHTML = `
                        <div class="summary-item">
                            <span>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß:</span>
                            <span class="summary-value">${data.checkedInCount}/${employees.length}</span>
                        </div>
                        <div class="summary-item">
                            <span>‡∏°‡∏≤‡∏™‡∏≤‡∏¢:</span>
                            <span class="summary-value">${data.lateCount} ‡∏Ñ‡∏ô</span>
                        </div>
                        <div class="summary-item">
                            <span>‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡πÅ‡∏•‡πâ‡∏ß:</span>
                            <span class="summary-value">${data.checkedOutCount}/${employees.length}</span>
                        </div>
                    `;
                    
                    // Update late employees
                    if (data.lateEmployees && data.lateEmployees.length > 0) {
                        document.getElementById('lateEmployees').innerHTML = data.lateEmployees.map(emp => `
                            <div class="late-item">
                                <strong>${emp.name}</strong><br>
                                ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô: ${emp.checkInTime} ‡∏ô. (‡∏™‡∏≤‡∏¢ ${emp.lateMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ)
                            </div>
                        `).join('');
                    } else {
                        document.getElementById('lateEmployees').innerHTML = '<p style="text-align: center; color: #28a745;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏°‡∏≤‡∏™‡∏≤‡∏¢ üëç</p>';
                    }
                    
                    // Update early employees
                    if (data.earlyEmployees && data.earlyEmployees.length > 0) {
                        document.getElementById('earlyEmployees').innerHTML = data.earlyEmployees.map(emp => `
                            <div class="early-item">
                                <strong>${emp.name}</strong><br>
                                ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå: ${emp.checkOutTime} ‡∏ô. (‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô ${emp.earlyMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ)
                            </div>
                        `).join('');
                    } else {
                        document.getElementById('earlyEmployees').innerHTML = '<p style="text-align: center; color: #28a745;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ üëç</p>';
                    }
                    
                } else {
                    document.getElementById('todayStats').innerHTML = '<p style="color: #dc3545;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error + '</p>';
                    document.getElementById('lateEmployees').innerHTML = '<p style="color: #dc3545;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error + '</p>';
                    document.getElementById('earlyEmployees').innerHTML = '<p style="color: #dc3545;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error + '</p>';
                }
            } catch (error) {
                document.getElementById('todayStats').innerHTML = '<p style="color: #dc3545;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                document.getElementById('lateEmployees').innerHTML = '<p style="color: #dc3545;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                document.getElementById('earlyEmployees').innerHTML = '<p style="color: #dc3545;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                console.error('Dashboard error:', error);
            }
            
            updateSalaryStats();
        }

        function updateSalaryStats() {
            // Mock salary stats calculation
            const totalSalary = employees.reduce((sum, emp) => sum + (emp.salary || 0), 0);
            const estimatedOT = 5000; // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£
            const socialSecurity = 750; // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£
            
            document.getElementById('salaryStats').innerHTML = `
                <div class="summary-item">
                    <span>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏ß‡∏°:</span>
                    <span class="summary-value">${totalSalary.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <div class="summary-item">
                    <span>OT ‡∏£‡∏ß‡∏° (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì):</span>
                    <span class="summary-value">${estimatedOT.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <div class="summary-item">
                    <span>‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°:</span>
                    <span class="summary-value">-${socialSecurity.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <div class="summary-item">
                    <span>‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì):</span>
                    <span class="summary-value" style="color: #28a745;">${(totalSalary + estimatedOT - socialSecurity).toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                </div>
            `;
        }

        function refreshDashboard() {
            loadDashboardData();
            showMessage('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        function generateReport() {
            showMessage('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤', 'warning');
        }

        function generateEmployeeReport() {
            const selectedEmployee = document.getElementById('reportEmployee').value;
            if (!selectedEmployee) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'warning');
                return;
            }

            const employee = employees.find(emp => emp.id === selectedEmployee);
            if (!employee) {
                showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'danger');
                return;
            }

            const reportHTML = `
                <div class="admin-card">
                    <h3>üë§ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• - ${employee.name}</h3>
                    <div class="admin-section">
                        <div class="admin-card">
                            <h4>üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</h4>
                            <div class="summary-item">
                                <span>‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</span>
                                <span class="summary-value">22/22 ‡∏ß‡∏±‡∏ô</span>
                            </div>
                            <div class="summary-item">
                                <span>‡∏°‡∏≤‡∏™‡∏≤‡∏¢:</span>
                                <span class="summary-value">2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                            </div>
                            <div class="summary-item">
                                <span>‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤:</span>
                                <span class="summary-value">0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                            </div>
                            <div class="summary-item">
                                <span>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°:</span>
                                <span class="summary-value">176 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span>
                            </div>
                            <div class="summary-item">
                                <span>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á OT:</span>
                                <span class="summary-value">8 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span>
                            </div>
                        </div>
                        
                        <div class="admin-card">
                            <h4>üí∞ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h4>
                            <div class="summary-item">
                                <span>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô:</span>
                                <span class="summary-value">${employee.salary.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                            </div>
                            <div class="summary-item">
                                <span>‡∏Ñ‡πà‡∏≤ OT (8 ‡∏ä‡∏°. x ${config.otRate} ‡∏ö‡∏≤‡∏ó):</span>
                                <span class="summary-value">${(8 * config.otRate).toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                            </div>
                            <div class="summary-item">
                                <span>‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏Å:</span>
                                <span class="summary-value">${(employee.salary + (8 * config.otRate)).toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                            </div>
                            <div class="summary-item">
                                <span>‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° (${config.socialSecurityRate}%):</span>
                                <span class="summary-value">-${Math.min((employee.salary * config.socialSecurityRate / 100), config.socialSecurityCap).toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                            </div>
                            <div class="summary-item">
                                <span><strong>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</strong></span>
                                <span class="summary-value" style="color: #28a745;"><strong>${(employee.salary + (8 * config.otRate) - Math.min((employee.salary * config.socialSecurityRate / 100), config.socialSecurityCap)).toLocaleString()} ‡∏ö‡∏≤‡∏ó</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('reportResult').innerHTML = reportHTML;
            showMessage('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        }

        function exportToSheets() {
            if (config.googleSheetsUrl) {
                window.open(config.googleSheetsUrl, '_blank');
            } else {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Google Sheets URL ‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤', 'warning');
            }
        }

        function getCurrentLocation() {
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        document.getElementById('officeLat').value = position.coords.latitude.toFixed(6);
                        document.getElementById('officeLng').value = position.coords.longitude.toFixed(6);
                        showMessage('‡πÑ‡∏î‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    },
                    function(error) {
                        showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ: ' + error.message, 'danger');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                showMessage('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS', 'danger');
            }
        }

        function showMessage(message, type = 'success') {
            const messageArea = document.getElementById('messageArea');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            messageArea.innerHTML = '';
            messageArea.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
